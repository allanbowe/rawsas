---
title: 'Extracting Active Directory accounts into SAS using Powershell'
date: '2016-06-22 16:37:00'
path: '/extracting-active-directory-accounts-into-sas-using-powershell/'
tags:
  - Movable Type
---

Having a list of domain users and associated properties can be useful for a number of reasons:<br /><br /><ul><li>Identifying joiners / leavers</li><li>Getting a list of employees</li><li>Converting usernames into email addresses</li><li>Alerting administrators when accounts are locked out</li></ul><div>Below is an approach for obtaining those users, producing a SAS dataset that could serve in a DI job for staging a database table.</div><div><blockquote style="margin-bottom: 0.0001pt;"><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: green; font-family: &quot;courier new&quot;;">/* set up command via pipe fileref */</span><span style="background: white; font-family: &quot;courier new&quot;;"><o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">options</span><span style="background: white; font-family: &quot;courier new&quot;;"> </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">noquotelenmax</span><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">filename</span><span style="background: white; font-family: &quot;courier new&quot;;"> process </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">pipe</span><span style="background: white; font-family: &quot;courier new&quot;;"> <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: purple; font-family: &quot;courier new&quot;;">"powershell ""Get-ADUser -Filter {enabled -eq $True} -properties Title,LockedOut,Created,Department,EmailAddress<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: purple; font-family: &quot;courier new&quot;;">&nbsp; |Select-Object SamAccountName,Name,GivenName,Surname,UserPrincipalName,DistinguishedName,Title,LockedOut,created,Department,EmailAddress<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: purple; font-family: &quot;courier new&quot;;">&nbsp; |Export-CSV&nbsp; '%sysfunc(pathname(work))ad_users.csv' "" "</span><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><br /></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: green; font-family: &quot;courier new&quot;;">/* execute command and capture any output from the shell */</span><span style="background: white; font-family: &quot;courier new&quot;;"><o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><b><span style="background: white; color: navy; font-family: &quot;courier new&quot;;">data</span></b><span style="background: white; font-family: &quot;courier new&quot;;"> </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">_null_</span><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">infile</span><span style="background: white; font-family: &quot;courier new&quot;;"> process; <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">input</span><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; <span style="color: blue;">list</span></span><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><b><span style="background: white; color: navy; font-family: &quot;courier new&quot;;">run</span></b><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><br /></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; color: green; font-family: &quot;courier new&quot;;">/* load CSV into SAS dataset */</span><span style="background: white; font-family: &quot;courier new&quot;;"><o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><b><span style="background: white; color: navy; font-family: &quot;courier new&quot;;">data</span></b><span style="background: white; font-family: &quot;courier new&quot;;"> AD_USERS;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">infile</span><span style="background: white; font-family: &quot;courier new&quot;;"> </span><span style="background: white; color: purple; font-family: &quot;courier new&quot;;">"%sysfunc(pathname(work))ad_users.csv"</span><span style="background: white; font-family: &quot;courier new&quot;;"> </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">dsd</span><span style="background: white; font-family: &quot;courier new&quot;;"> <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp;&nbsp;&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">firstobs</span><span style="background: white; font-family: &quot;courier new&quot;;">=</span><b><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">3</span></b><span style="background: white; font-family: &quot;courier new&quot;;"> </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">lrecl</span><span style="background: white; font-family: &quot;courier new&quot;;">=</span><b><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">10000</span></b><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">input</span><span style="background: white; font-family: &quot;courier new&quot;;"> SamAccountName:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$100.</span><span style="background: white; font-family: &quot;courier new&quot;;"> name:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$100.</span><span style="background: white; font-family: &quot;courier new&quot;;"> GivenName:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$50.</span><span style="background: white; font-family: &quot;courier new&quot;;"> <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp;&nbsp;&nbsp; SurName:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$50.</span><span style="background: white; font-family: &quot;courier new&quot;;"> UserPrincipalName:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$200.</span><span style="background: white; font-family: &quot;courier new&quot;;"> <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp;&nbsp;&nbsp; DistinguishedName:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$500.</span><span style="background: white; font-family: &quot;courier new&quot;;"> Title:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$100.</span><span style="background: white; font-family: &quot;courier new&quot;;"> LockedOut:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$5.</span><span style="background: white; font-family: &quot;courier new&quot;;"> <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp;&nbsp;&nbsp; created:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$25.</span><span style="background: white; font-family: &quot;courier new&quot;;"> Department:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$50.</span><span style="background: white; font-family: &quot;courier new&quot;;"> EmailAddress:</span><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">$100.</span><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">if</span><span style="background: white; font-family: &quot;courier new&quot;;"> index(DistinguishedName,</span><span style="background: white; color: purple; font-family: &quot;courier new&quot;;">'OU=Employees'</span><span style="background: white; font-family: &quot;courier new&quot;;">) </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">then</span><span style="background: white; font-family: &quot;courier new&quot;;"> EMPLOYEE_FLG=</span><b><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">1</span></b><span style="background: white; font-family: &quot;courier new&quot;;">; <o:p></o:p></span></div><div style="margin-bottom: 0.0001pt;"><span style="background: white; font-family: &quot;courier new&quot;;">&nbsp; </span><span style="background: white; color: blue; font-family: &quot;courier new&quot;;">else</span><span style="background: white; font-family: &quot;courier new&quot;;"> EMPLOYEE_FLG=</span><b><span style="background: white; color: teal; font-family: &quot;courier new&quot;;">0</span></b><span style="background: white; font-family: &quot;courier new&quot;;">;<o:p></o:p></span></div><div><b><span style="background: white; color: navy; font-family: &quot;courier new&quot;;">run</span></b><span style="background: white; font-family: &quot;courier new&quot;;">;</span><o:p></o:p></div></blockquote><div><o:p></o:p></div></div><div><br /></div><div>This will extract all ACTIVE accounts (enabled eq $True) with some selected additional properties (more&nbsp;<a href="http://social.technet.microsoft.com/wiki/contents/articles/12037.active-directory-get-aduser-default-and-extended-properties.aspx" target="_blank">here</a>). &nbsp;Some conditional logic is applied to distinguish employees from service accounts.</div><div><br /><div>Prerequisites:</div><div><ul><li>X Command enabled (see&nbsp;<a href="http://support.sas.com/kb/15/179.html" target="_blank">here&nbsp;</a>for instructions, is similar process for workspace servers)</li><li>Powershell installed</li></ul></div></div><div>Enjoy!</div><div><br /></div><div><br /></div>