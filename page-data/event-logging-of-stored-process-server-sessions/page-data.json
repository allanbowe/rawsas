{"componentChunkName":"component---src-templates-template-tsx","path":"/event-logging-of-stored-process-server-sessions/","result":{"data":{"post":{"id":"bfecf5c9-7d1e-55b2-9c0d-90b6ee0d8973","html":"<p>Having seemingly brought down our 9.2 Windows 2008 STP server (only in DEV!!) during development of a yet another (awesome) STP web app, it occurred to me that more information was needed about just how many requests were being batted over.</p>\n<hr />\n<div style=\"color: red; font-family: 'trebuchet ms', arial, 'arial unicode ms', sans-serif; font-weight: bold;\">Stored Process Error</div><div style=\"font-family: 'trebuchet ms', arial, 'arial unicode ms', sans-serif; font-size: small;\">\n<h2 style=\"font-size: medium;\">Unable to execute stored process.</h2>\n<h2 style=\"font-size: medium;\">The server is not running (paused/deferred stop mode?).</h2></div>\n<hr />\nSo, inspired by Quentin McMullen's <a href=\"https://bi-notes.com/2014/02/sas_stored_process_log/\">excellent post</a>, I wanted to share my approach.\n<p><strong>Step 1</strong> was to create a table to log the events. This was structured as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> <span class=\"token punctuation\">[</span>dbo<span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">[</span>STP_LOGGER<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span>\n <span class=\"token punctuation\">[</span>PROCESSED_DTTM<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span>datetime2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">[</span>STATUS_CD<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token number\">8</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">[</span>_PROGRAM<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">500</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">[</span>_METAPERSON<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">100</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">[</span>SYSJOBID<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">12</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">[</span>_SESSIONID<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">50</span><span class=\"token punctuation\">)</span> <span class=\"token boolean\">NULL</span><span class=\"token punctuation\">,</span>\n <span class=\"token punctuation\">[</span>GLOB_VARS<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">char</span><span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span><span class=\"token number\">2000</span><span class=\"token punctuation\">)</span> <span class=\"token boolean\">NULL</span></code></pre></div>\n<p>Note that this table was not a SAS table (which could be subject to locking). If you have no other choice but to use a SAS table, please refer to the previous post for attempting SAS locks (noting that this <a href=\"/get-physical-path-from-metadata-libref\">cannot be done via the meta engine</a>).</p>\n<p><strong>Step 2</strong> was to create a <a href=\"https://github.com/sashub/macro/blob/master/standalone/stp_logger.sas\">macro</a> to update the table (to be placed somewhere in <a href=\"https://support.sas.com/documentation/cdl/en/hostwin/63285/HTML/default/viewer.htm#win-sysop-sasautos.htm\">SASAUTOS</a>). Example below:</p>\n<div class=\"gatsby-highlight\" data-language=\"sas\"><pre class=\"language-sas\"><code class=\"language-sas\"><span class=\"token macro-declaration\"><span class=\"token keyword\">%macro</span> stp_logger(status_cd=)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro-keyword keyword\">%local</span> global_vars<span class=\"token punctuation\">;</span>\n  <span class=\"token step keyword\">proc sql</span> noprint<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">select</span> <span class=\"token function keyword\">cats</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span><span class=\"token string\">'='</span><span class=\"token punctuation\">,</span>value<span class=\"token punctuation\">)</span>\n    into: global_vars\n    separated <span class=\"token keyword\">by</span> <span class=\"token string\">'|'</span>\n    from dictionary<span class=\"token punctuation\">.</span>macros\n    <span class=\"token keyword\">where</span> scope <span class=\"token operator\">=</span> <span class=\"token string\">'GLOBAL'</span>\n    <span class=\"token keyword\">and</span> <span class=\"token function keyword\">substr</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">3</span><span class=\"token punctuation\">)</span> <span class=\"token operator-keyword operator\">not</span> <span class=\"token function keyword\">in</span><span class=\"token punctuation\">(</span><span class=\"token string\">'SYS'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'SQL'</span><span class=\"token punctuation\">,</span><span class=\"token string\">'SAS'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">and</span> <span class=\"token function keyword\">substr</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span> <span class=\"token operator-keyword operator\">ne</span> <span class=\"token string\">'*'</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token function keyword\">%assign_lib</span><span class=\"token punctuation\">(</span>libref<span class=\"token operator\">=</span>web<span class=\"token punctuation\">)</span>\n\n  <span class=\"token step keyword\">proc datasets</span> library<span class=\"token operator\">=</span>work<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">delete</span> append<span class=\"token punctuation\">;</span>\n  <span class=\"token step keyword\">run</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token step keyword\">data</span> append <span class=\"token operator\">/</span>view<span class=\"token operator\">=</span>append<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token number\">0</span> <span class=\"token keyword\">then</span> <span class=\"token keyword\">set</span> web<span class=\"token punctuation\">.</span>stp_logger<span class=\"token punctuation\">;</span>\n    PROCESSED_DTTM<span class=\"token operator\">=</span><span class=\"token macro-keyword keyword\">%sysfunc</span><span class=\"token punctuation\">(</span><span class=\"token function keyword\">datetime</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    STATUS_CD<span class=\"token operator\">=</span><span class=\"token string\">\"&amp;status_cd\"</span><span class=\"token punctuation\">;</span>\n    _PROGRAM<span class=\"token operator\">=</span><span class=\"token string\">\"&amp;_program\"</span><span class=\"token punctuation\">;</span>\n    _METAPERSON<span class=\"token operator\">=</span><span class=\"token string\">\"&amp;_metaperson\"</span><span class=\"token punctuation\">;</span>\n    SYSJOBID<span class=\"token operator\">=</span><span class=\"token string\">\"&amp;sysjobid\"</span><span class=\"token punctuation\">;</span><span class=\"token operator\">&lt;</span><span class=\"token operator\">/</span>span<span class=\"token operator\">></span>\n  <span class=\"token macro-keyword keyword\">%if</span> <span class=\"token operator-keyword operator\">not</span> <span class=\"token macro-keyword keyword\">%symexist</span><span class=\"token punctuation\">(</span>_SESSIONID<span class=\"token punctuation\">)</span> <span class=\"token macro-keyword keyword\">%then</span> <span class=\"token macro-keyword keyword\">%do</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* session id is stored in the replay variable but needs to be extracted */</span>\n    _replay<span class=\"token operator\">=</span><span class=\"token function keyword\">symget</span><span class=\"token punctuation\">(</span><span class=\"token string\">'_replay'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _replay<span class=\"token operator\">=</span><span class=\"token function keyword\">subpad</span><span class=\"token punctuation\">(</span>_replay<span class=\"token punctuation\">,</span><span class=\"token function keyword\">index</span><span class=\"token punctuation\">(</span>_replay<span class=\"token punctuation\">,</span><span class=\"token string\">'_sessionid='</span><span class=\"token punctuation\">)</span><span class=\"token operator\">+</span><span class=\"token number\">11</span><span class=\"token punctuation\">,</span><span class=\"token function keyword\">length</span><span class=\"token punctuation\">(</span>_replay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    index<span class=\"token operator\">=</span><span class=\"token function keyword\">index</span><span class=\"token punctuation\">(</span>_replay<span class=\"token punctuation\">,</span><span class=\"token string\">'&amp;'</span><span class=\"token punctuation\">)</span><span class=\"token operator\">-</span><span class=\"token number\">1</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> index<span class=\"token operator\">=</span><span class=\"token operator\">-</span><span class=\"token number\">1</span> <span class=\"token keyword\">then</span> index<span class=\"token operator\">=</span><span class=\"token function keyword\">length</span><span class=\"token punctuation\">(</span>_replay<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _replay<span class=\"token operator\">=</span><span class=\"token function keyword\">substr</span><span class=\"token punctuation\">(</span>_replay<span class=\"token punctuation\">,</span><span class=\"token number\">1</span><span class=\"token punctuation\">,</span>index<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    _SESSIONID<span class=\"token operator\">=</span>_replay<span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">drop</span> _replay index<span class=\"token punctuation\">;</span>\n  <span class=\"token macro-keyword keyword\">%end</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro-keyword keyword\">%else</span> <span class=\"token macro-keyword keyword\">%do</span><span class=\"token punctuation\">;</span>\n    <span class=\"token comment\">/* explicitly created sessions are automatically available */</span>\n    _SESSIONID<span class=\"token operator\">=</span><span class=\"token function keyword\">symget</span><span class=\"token punctuation\">(</span><span class=\"token string\">'_SESSIONID'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token macro-keyword keyword\">%end</span><span class=\"token punctuation\">;</span>\n    GLOB_VARS<span class=\"token operator\">=</span><span class=\"token function keyword\">symget</span><span class=\"token punctuation\">(</span><span class=\"token string\">'global_vars'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">output</span><span class=\"token punctuation\">;</span>\n    stop<span class=\"token punctuation\">;</span>\n  <span class=\"token step keyword\">run</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token step keyword\">proc append</span> base<span class=\"token operator\">=</span>web<span class=\"token punctuation\">.</span>stp_logger <span class=\"token keyword\">data</span><span class=\"token operator\">=</span>append<span class=\"token punctuation\">;</span>run<span class=\"token punctuation\">;</span>\n\n  <span class=\"token step keyword\">proc sql</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">drop</span> view append<span class=\"token punctuation\">;</span>\n\n<span class=\"token macro-end\"><span class=\"token keyword\">%mend</span> stp_logger</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><b>Step 3</b> was to call the macro.   The quick / dirty way would be to simply include it in the SAS programs directly, but that quickly becomes unmanageable when dealing with a large number of STPs.  Another option is to include in the autoexec, but that will only deal with program ENTRY (not exit).\nThe best approach, as endorsed by <a href=\"https://bi-notes.com/2014/02/sas_stored_process_log/#comment-1955\">Don Henderson</a>, is to use the STP init and term programs.  These are straightforward .sas programs that run on an STP session’s entry and exit.  Configuration is simple, and explained here:  <a href=\"https://support.sas.com/kb/39/250.html\"><a href=\"https://support.sas.com/kb/39/250.html\">https://support.sas.com/kb/39/250.html</a></a>.</p>\n<p>This approach is fantastic as it will ensure that ALL calls to the STP server are logged (eg via EG, AMO, WRS, every custom web app, etc etc).   Simply add the following one-liners to each file:</p>\n<div class=\"gatsby-highlight\" data-language=\"sas\"><pre class=\"language-sas\"><code class=\"language-sas\"><span class=\"token function keyword\">%stp_logger</span><span class=\"token punctuation\">(</span>status_cd<span class=\"token operator\">=</span>SrvEnter<span class=\"token punctuation\">)</span>  <span class=\"token comment\">/* goes in the init file */</span>\n<span class=\"token function keyword\">%stp_logger</span><span class=\"token punctuation\">(</span>status_cd<span class=\"token operator\">=</span>SrvExit<span class=\"token punctuation\">)</span>   <span class=\"token comment\">/* goes in the term file */</span></code></pre></div>\n<p>Boom, we are done, and here is an extract of the new logging table:</p>\n<p><img src=\"/45e987897554f08dfd95c1478cca7024/Capture_4.png\" alt=\"\"></p>\n<p>See that highlighted row?  A hung session with my name against it…</p>\n<p><img src=\"https://1.bp.blogspot.com/-iq3rv-RygCQ/VenmQacknMI/AAAAAAAAAlw/uz0v7PUwxQU/s320/2010-02-24-hangman.jpg\" alt=\"\"></p>\n<p><strong>EDIT 13OCT2015:</strong>\n<em>The connection issue was finally resolved by setting the <a href=\"https://support.sas.com/rnd/itech/doc9/admin_oma/sasserver/iombridge/sp_sercl.html#sasRecycleActivationLimit\">Recycle Activation Limit</a> to 1.  This had no noticeable effect on performance.</em></p>","frontmatter":{"title":"Event Logging of Stored Process Server Sessions","path":"/event-logging-of-stored-process-server-sessions/","previewImg":null,"tags":["SQL"],"date":"Sep 04, 2015"}}},"pageContext":{"archives":{"2012":8,"2013":10,"2014":4,"2015":7,"2016":17,"2017":12,"2018":9,"2019":2,"2020":3,"2021":1,"2022":7,"2023":1,"2024":1,"2025":3}}},"staticQueryHashes":["1133634862"],"slicesMap":{}}